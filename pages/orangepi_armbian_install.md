# Orange PI Zero - установка Armbian Linux

- [Образ OS](#образ-os)
- [Запись образа на Flash](#запись-образа-на-flash)
  - [Резервная копия карты](#резервная-копия-карты)
  - [Запись](#запись)
- [Подключение к Orange PI Zero](#подключение-к-orange-pi-zero)
- [Первая загрузка (настройка и обновление)](#первая-загрузка-настройка-и-обновление)
- [Настройка сети](#настройка-сети)
  - [Получаем имена сетевых интерфейсов](#получаем-имена-сетевых-интерфейсов)
  - [Установка динамического или статического IP](#установка-динамического-или-статического-ip)
  - [Перезагрузка сети](#перезагрузка-сети)
  - [WIFI](#wifi)

Вспомнил про мою `Orange PI Zero`, включил, хотел обновить, но репозиториев уже не существует =/ 

Штош, обновим систему =)

Для установки я выбрал образ операционной системы от [armbian.com](https://www.armbian.com/orange-pi-zero/#kernels-archive-all) на базе `Debian Linux`.

По моему предыдущему опыту, помню, что `Armbian` вроде как новее и более оптимизированный чем образы с сайта [www.orangepi.org](http://www.orangepi.org/html/hardWare/computerAndMicrocontrollers/service-and-support/Orange-Pi-Zero.html)... Но это не точно =/

Изначально я хотел ставить `Ubuntu server`, но, на текущий момент его не оказалось на `Armbian`, а на `orangepi.org` были старые сборки версии 16. Возможно, это по тому, что `Ubuntu` больше не поддерживает 32 бит системы и последняя сборка датируется 2019 годом, как раз 16 версия. Этим, скорее всего объясняется тот факт, что я не смог обновить систему установленную ранее, так как у меня был установлен именно `Ubuntu Server`.

Так или иначе путь выбран.

Неплохой гайд по настройке можно найти на сайте `Armbian`: [https://docs.armbian.com/User-Guide_Getting-Started/#how-to-install-to-emmc-nand-sata-usb](https://docs.armbian.com/User-Guide_Getting-Started/#how-to-install-to-emmc-nand-sata-usb)

# Образ OS

Качаем Armbian тут: [https://www.armbian.com/orange-pi-zero/](https://www.armbian.com/orange-pi-zero/)

На момент написания статьи в разделе скачивания имеется три версии. Понять чем одна отличается от другой непросто. Вот что мне удалось установить:

- `Jammy` (stable user space) (мой выбор) - рекомендованная версия, определяет `Wifi` адаптер.
- `Bullseye` (stable user space) - дистрибутив больше по размеру чем `Jammy`.
- `Sid` (rolling user space) - опытным путем удалось установить что у этой версии не подключен `WiFi`.

# Запись образа на Flash

Для записи используем `Win32 Disk Imager`

Качать тут: [https://sourceforge.net/projects/win32diskimager/files/Archive/](https://sourceforge.net/projects/win32diskimager/files/Archive/)

## Резервная копия карты

Если у вас на карте есть установленная ранее система или что то ценное и вы не хотите это потерять, то, делаем резервную копию. Для этого, указываем имя файла в который хотим сохранить образ и жмем `read`.

![Создаем резервную копию](./assets/orangepi_armbian_install/2022-10-05%2018_45_17-Win32%20Disk%20Imager%20-%201.0.png)

Позже, можно делать подобные сохранения с установленной вами системой перед тем, как начать экспериментировать =)

## Запись

Изначально, образ OS заархивирован сохраняется в формате `.xs` виде файла `Armbian_22.08.2_Orangepizero_jammy_current_5.15.69.xs`. Программа`Win32 Disk Imager` не понимает файлов `.xs`, по этому перед записью образ надо распаковать.

Я использовал `Total7zip` плагин ([http://totalcmd.net/plugring/Total7zip.html](http://totalcmd.net/plugring/Total7zip.html)) для `Total Commander`. Возможно у вас будет свой путь =)

Выбираем распакованный образ и записываем.

![Запись образа](./assets/orangepi_armbian_install/2022-10-05%2019_13_49-Win32%20Disk%20Imager%20-%201.0.png)

Все, можно вставлять карту в Orange PI.

# Подключение к Orange PI Zero

Для подключения нам понадобится SSH клиент. Я буду использовать [Putty](https://www.putty.org/).

Брать тут: [https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html](https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html)

Для первого подключения желательно иметь подключение к локальной сети по кабелю, хотя, вроде работает и по `USB`. 

Первая загрузка занимает более 2х минут и в это время вы не сможете подключится. Это нормально.

По умолчанию `IP` адрес устройства определяется автоматически через `DHCP`. Узнать его можно при помощи сканирования сети, либо через роутер (мой случай).

Если сети нет, подключаемся при помощи `USB`. Система автоматически выделит `COM` порт. Указываем порт в окне подключения `PUTTY`, предварительно установив галочку `serial`. У меня подключается по `COM3`.

![Conntect](./assets/orangepi_armbian_install/2022-10-05%2020_34_10-PuTTY%20Configuration.png)

# Первая загрузка (настройка и обновление)

Первая загрузка занимает около 2 минут (зависит от класса карты).

Для входа первый раз используем:

- `login`: root
- `password`: 1234

![first login](./assets/orangepi_armbian_install/2022-10-05%2021_49_51-192.168.1.4%20-%20PuTTY.png)

Далее проходим ряд настроек инициализации.

1. Задаем пароль для `root`.
2. Выбираем тип командной оболочки (`bash` или `zsh`).
3. Указываем имя пользователя и пароль.
4. Задаем язык.
5. Указываем временной пояс.

![Setup](./assets/orangepi_armbian_install/2022-10-05%2021_58_25-192.168.1.4%20-%20PuTTY.png)

![Setup](./assets/orangepi_armbian_install/2022-10-05%2022_07_45-192.168.1.4%20-%20PuTTY.png)

Необязательно но желательно обновляем систему.

```
apt update
apt upgrade
```

# Настройка сети

Официальная `Wiki` от `Debian`: [https://wiki.debian.org/NetworkConfiguration](https://wiki.debian.org/NetworkConfiguration)

Там же, можно найти ссылку вот на этот познавательный документ: [https://www.debian.org/doc/manuals/debian-reference/ch05.en.html#_the_modern_network_configuration_without_gui](https://www.debian.org/doc/manuals/debian-reference/ch05.en.html#_the_modern_network_configuration_without_gui)

## Получаем имена сетевых интерфейсов

Первое что нужно сделать, узнать имена сетевых интерфейсов.

```
ls /sys/class/net
```

В ответе получаем `eth0` (сеть), `lo` (localhost) и `wlan0` (wifi).

Можно воспользоваться командой `ifconfig` которая покажет информацию поподробнее.

```
ifconfig
```

Еще вариант.

```
ip a
```

## Установка динамического или статического IP

Настройки сети (сетевых интерфейсов) находятся в файле `/etc/network/interfaces`. Для того что бы задать сетевые настройки надо добавить или изменить раздел для нужного интерфейса, в нашем случае это `eth0`.

Есть другие способы задать настройки, но этот более универсален, так как все параметры подключения можно указать в одном месте. Другие методы описаны в документации о которой я говорил [ранее](#настройка-сети).

Также, отмечу, что указать `dns` сервера строкой `dns-nameservers` в файле `/etc/network/interfaces` только в том случае, если установлена программа `resolvconf ` (она установлена по умолчанию), иначе надо править `/etc/resolve.conf`. Подробнее об этом в [документации](#настройка-сети).

Для использования `DHCP` (динамический IP, когда настройки сети задаются роутером автоматически) делаем так:

```
auto eth0
allow-hotplug eth0
iface eth0 inet dhcp
```

Для того, что бы сделать IP адрес `статическим` делаем так:

```
auto eth0
iface eth0 inet static
    address 192.168.1.11/24
    gateway 192.168.1.1
    dns-nameservers 8.8.8.8 8.8.4.4
```

## Перезагрузка сети

После внесения изменений либо перезагружаем `Orange PI`, либо делаем так:

```
sudo systemctl restart networking
```

Так работает странно и ругается на DNS. После перезагрузки вроде не ругается, но уверенности уже ни в чем нет =(

Еще вариант перезагрузки сетевого интерфейса:

```
sudo ifdown eth0
sudo ifup eth0
```

Кстати, если вы подключены через сеть, то скорее всего у вас нарушится соединение с `PUTTY`, и в случае с `ifup` вы не сможете запустить команду =)

## WIFI

Первым делом определяем имя сетевого интерфейса для беспроводной сети.

```
ip a
```

В моем случае это `wlan0`.

Как я понимаю, интерфейсы для беспроводной сети `Wifi`начинаются на `w`, в то время как для проводной сети на `eth`.

Получаем список точек подключения доступных нашему адаптеру.

```
sudo iwlist wlan0 scan | grep ESSID
```

Используем `grep ESSID` что бы убрать лишнее. Уберите `grep` если вам любопытно поглядеть, какую еще информацию о подключениях выдает команда.

Однократное выполнение команды `iwlist` показывает не все точки доступа. Повторный вызов может показать те точки, которые не удалось найти сразу. По всей видимости список получаемых точек доступа зависит от силы сигнала и какой то внутренней коммуникации между точками доступа, так как они то появляются то исчезают.

Добавляем в `/etc/network/interfaces` следующий блок.

```
allow-hotplug wlan0
iface wlan0 inet dhcp
wpa-ssid MY_SPOT_SSID_NAME
wpa-psk mY@paS5w0Rd
```

Перезапускаем интерфейс `wlan0`.

```
sudo ifdown wlan0
sudo ifup wlan0
```

Поднять `wlan0` с постоянным `IP` мне не удалось =( Не удалось это сделать и с помощью `armbian-config` =(